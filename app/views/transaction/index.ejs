<!doctype html>
<html lang="en">
    <head>
        <% include ../partials/head %>

    </head>
    <body>
    <% include ../partials/topnav %>

     <div class="modal  fade" id="modalAddNewTransaction" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <form id="add-unit-form" method="post" action="/transaction/create">
          <input type="hidden" name="_csrf" value="<%= token %>">
          <div class="modal-content bg-lighter">
            <div class="modal-header">
                <!-- Header -->
              <h3 class="modal-title" id="unit-modal-title">Add a New Transaction</h3>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
    
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Properties
                    </label>
                    <select class="form-control" id="transaction_property" name="transaction[property_id]" data-toggle="select"  data-options='{"placeholder": "Select a Property"}' required>
                      <option></option>
                      <% properties.forEach(property => {%>
                      	<option value="<%= property.id%>"><%= property.address%>, <%= property.city%></option>
                      <% }) %>
                    </select>  
                  </div>
    
                </div>
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      To/From
                    </label>
                    <input type="text" id="transaction_user" name="transaction[user]" class="form-control">
                  </div>
    
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Category
                    </label>
                  <input type="text" id="transaction_category" name="transaction[category]" class="form-control">
                  </div>
    
                </div>
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Amount
                    </label>
                    <div class="input-group input-group-merge mb-3">
                      <input type="text" id="transaction_amount" onkeypress="return isNumberKey(event)"  name="transaction[amount]" class="form-control form-control-prepended number">
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <span>£</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div> <!-- / .row -->
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Account
                    </label>
                  <input type="text" id="transaction_account" name="transaction[account]" class="form-control">
                  </div>
    
                </div>
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Date
                    </label>
                    <input type="text" id="transaction_created_at" name="transaction[created_at]" class="form-control" value=""  data-toggle="flatpickr" required>
                  </div>
    
                </div>
               </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="addUnitBtn">Add</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- MAIN CONTENT
    ================================================== -->
    <div class="main-content">

      <!-- HEADER -->
      <div class="header">
        <div class="container">
          
          <!-- Body -->
          <div class="header-body">
            <div class="row align-items-end">
              <div class="col">
                

                <!-- Title -->
                <h1 class="header-title">
                  Transactions
                </h1>

              </div>
              <div class="col-auto">
                
                <!-- Button -->
                <a href="#" class="btn btn-primary lift" data-toggle="modal" data-target="#modalAddNewTransaction">
                  Add Transaction
                </a>
				
              </div>
            </div> <!-- / .row -->
			
            <div class="row align-items-center">
              <div class="col">
                
                <!-- Nav -->
                <ul class="nav nav-tabs nav-overflow header-tabs">
                  <li class="nav-item">
                    <a href="transactions.html" class="nav-link active">
                      All transactions
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="transactions-review.html" class="nav-link">
                      Income
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="transactions-review.html" class="nav-link">
                      Expenses
                    </a>
                  </li>
                </ul>

              </div>
            </div>
          </div> <!-- / .header-body -->

        </div>
      </div> <!-- / .header -->

      <!-- CONTENT -->
      <div class="container">
		  
	            <!-- Card -->
	            <div class="card" data-toggle="lists" data-options='{"valueNames": ["orders-order", "orders-product", "orders-date", "orders-total", "orders-status", "orders-method"]}'>
	              <div class="card-header">
	                <div class="row align-items-center">
	                  <div class="col">

	                    <!-- Search -->
	                    <form class="row align-items-center">
	                      <div class="col-auto pr-0">
	                        <span class="fe fe-search text-muted"></span>
	                      </div>
	                      <div class="col">
	                          <input type="search" class="form-control form-control-flush search" placeholder="Search">
	                      </div>
	                    </form>
                    
	                  </div>
	                  <div class="col-auto">
                    
	                    <!-- Button -->

	                    <div class="dropdown">
	                      <button class="btn btn-sm btn-white dropdown-toggle" type="button" id="bulkActionDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	                        Bulk action
	                      </button>
	                      <div class="dropdown-menu dropdown-menu-right" aria-labelledby="bulkActionDropdown">
	                        <a class="dropdown-item" href="#!">Edit</a>
	                        <a class="dropdown-item" href="#!">Delete</a>
	                      </div>
	                    </div>

	                  </div>
	                </div> <!-- / .row -->
	              </div>
	              <div class="table-responsive">
	                <table class="table table-sm table-nowrap card-table">
	                  <thead>
	                    <tr>
	                      <th>
	                        <div class="custom-control custom-checkbox table-checkbox">
	                          <input type="checkbox" class="custom-control-input" name="ordersSelect" id="ordersSelectAll">
	                          <label class="custom-control-label" for="ordersSelectAll">
	                            &nbsp;
	                          </label>
	                        </div>
	                      </th>
	                      <th>
	                        <a href="#" class="text-muted sort" data-sort="orders-date">
	                          Date
	                        </a>
	                      </th>
	                      <th>
	                        <a href="#" class="text-muted sort" data-sort="orders-product">
	                          Property
	                        </a>
	                      </th>
	                      <th>
	                        <a href="#" class="text-muted sort" data-sort="orders-total">
	                          To/From
	                        </a>
	                      </th>
	                      <th>
	                        <a href="#" class="text-muted sort" data-sort="orders-total">
	                          Category
	                        </a>
	                      </th>
	                      <th>
	                        <a href="#" class="text-muted sort" data-sort="orders-status">
	                          Account
	                        </a>
	                      </th>
	                      <th colspan="2">
	                        <a href="#" class="text-muted sort" data-sort="orders-method">
	                          Amount
	                        </a>
	                      </th>
	                    </tr>
	                  </thead>
	                  <tbody class="list transaction-list">
	                  </tbody>
	                </table>
	              </div>
	            </div>

	          </div>
	        </div> <!-- / .row -->
	      </div>
		  
		  

      </div>
      
    </div> <!-- / .main-content -->

    <!-- JAVASCRIPT
    ================================================== -->
    <% include ../partials/scripts %>

    <script type="text/javascript">
    	$(function() {
    		fetch('/transaction/all/get', {method: 'GET'})
	            .then(res => res.json())
	            .then(res => {
	            	$('.transaction-list').empty();
	            	// const property = properties.filter(property => property.is == transaction.property_id);
	            	// const propertyName = property.address + ', ' + property.city;
	            	res.transactions.map(transaction => {
		            	const sign = parseFloat(transaction.amount) < 0;
		            	let amount = '£' + transaction.amount.replace('-', '');
		            	if (sign) {
		            		amount = '-' + amount;
		            	}
	            		$('.transaction-list').append(`
	            			<tr class="transaction-row">
			                  <td>
			                    <div class="custom-control custom-checkbox table-checkbox">
			                      <input type="checkbox" class="custom-control-input" name="ordersSelect" id="ordersSelectOne">
			                      <label class="custom-control-label" for="ordersSelectOne">
			                        &nbsp;
			                      </label>
			                    </div>
			                  </td>
			                  <td class="orders-date">
			                    <time datetime="${transaction.created_at}">${transaction.created_at}</time>
			                  </td>
			                  <td class="orders-product">
			                    ${transaction.propertyName}
			                  </td>
			                  <td class="orders-total">
			                    ${transaction.user}
			                  </td>
			                  <td class="orders-total">
			                    ${transaction.category}
			                  </td>
			                  <td class="orders-status">
			                    ${transaction.account}
			                  </td>
			                  <td class="orders-method">
			                    ${amount}
			                  </td>
			                  <td class="text-right">
			                    <div class="dropdown">
			                      <a href="#" class="dropdown-ellipses dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			                        <i class="fe fe-more-vertical"></i>
			                      </a>
			                      <div class="dropdown-menu dropdown-menu-right">
			                        <a href="#" data-id="${transaction.id}" class="dropdown-item view-transaction">
			                          View
			                        </a>
			                        <a href="#" data-id="${transaction.id}"  class="dropdown-item delete-transaction">
			                          Delete
			                        </a>
			                      </div>
			                    </div>
			                  </td>
			                </tr>
	            		`);
	            	});
	    		})
	            .catch(err => {
	                console.log(err);
	            })
    	});
    </script>
  </body>
</html>