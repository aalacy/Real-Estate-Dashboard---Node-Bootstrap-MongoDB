<!doctype html>
<html lang="en">
  <head>
      <% include ../partials/head %>
  </head>
  <body>

    <!-- Modal Add New Unit -->
    <div class="modal  fade" id="modalAddNewUnit" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <form id="add-unit-form" method="post" action="/property/unit/new/">
          <input type="hidden" name="_csrf" value="<%= token %>">
          <input type="hidden" id="property_id" name="property[id]" value="<%= property.id%>">
          <input type="hidden" name="unit[id]" value="">
          <input type="hidden" name="unit[tenants]" id="unit_tenants" value="">
          <div class="modal-content bg-lighter">
            <div class="modal-header">
                <!-- Header -->
              <h3 class="modal-title" id="unit-modal-title">Add a New Unit</h3>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
    
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Unit Description
                    </label>
                    <input type="text" id="unit_description" name="unit[description]" class="form-control" placeholder="Description" value="" required>
                  </div>
    
                </div>
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Deposit
                    </label>
                    <div class="input-group input-group-merge mb-3">
                      <input type="text" id="unit_deposit" onkeypress="return isNumberKey(event)"  name="unit[deposit]" class="form-control form-control-prepended number">
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <span>£</span>
                        </div>
                      </div>
                    </div>
                  </div>
    
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Start Date
                    </label>
                    <input type="text" id="unit_start_date" name="unit[start_date]" class="form-control" value=""  data-toggle="flatpickr" required>
                  </div>
    
                </div>
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      End Date (Optional)
                    </label>
                    <input type="text" id="unit_end_date" name="unit[end_date]" class="form-control" value=""  data-toggle="flatpickr">
                  </div>
    
                </div>
              </div> <!-- / .row -->
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Rent Price
                    </label>
                    <div class="input-group input-group-merge mb-3">
                      <input type="text" id="unit_rent_price" onkeypress="return isNumberKey(event)"  name="unit[rent_price]" class="form-control form-control-prepended number">
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <span>£</span>
                        </div>
                      </div>
                    </div>
                  </div>
    
                </div>
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Rent Frequency
                    </label>
                    <select class="form-control" id="unit_rent_frequency" name="unit[rent_frequency]" data-toggle="select" data-options='{"placeholder": "Select a frequency"}' required>
                      <option></option>
                      <option value="Daily">Daily</option>
                      <option value="Weekly">Weekly</option>
                      <option value="Fortnightly">Fortnightly</option>
                      <option value="Monthly">Monthly</option>
                    </select>
                  </div>
    
                </div>
              </div> <!-- / .row -->
              <div class="row">
                <div class="col-12 col-md-6">
                  <button type="submit" class="btn btn-outline-danger d-none btn-unit-delete action-unit">Delete this unit</button>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="addUnitBtn">Add</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Add New Tenant -->
    <div class="modal  fade" id="modalAddNewTenant" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <form id="add-tenant-form" method="post" action="/property/unit/tenant/new/">
          <input type="hidden" name="_csrf" value="<%= token %>">
          <input type="hidden" name="property[id]" value="<%= property.id%>">
          <input type="hidden" name="unit[id]" value="">
          <input type="hidden" id="tenant_id" name="tenant[id]" value="">
          <div class="modal-content bg-lighter">
            <div class="modal-header">
                <!-- Header -->
              <h3 class="modal-title" id="tenant-modal-title">Add a New Tenant</h3>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
    
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <div class="form-group">
                    <label>
                      First Name
                    </label>
                    <input type="text" id="tenant_first_name" name="tenant[first_name]" class="form-control" placeholder="First Name" value="" required>
                  </div>
    
                </div>
                <div class="col-12 col-md-6">
                  
                  <div class="form-group">
                    <label>
                      Last Name
                    </label>
                    <input type="text" id="tenant_last_name" name="tenant[last_name]" class="form-control" placeholder="Last Name" value="" required>
                  </div>
    
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <div class="form-group">
                    <label>
                      Email
                    </label>
                    <input type="email" id="tenant_email" name="tenant[email]" class="form-control" placeholder="Email" value="" required>
                  </div>
    
                </div>
                <div class="col-12 col-md-6">
                  
                  <div class="form-group">
                    <label>
                      Phone Number
                    </label>
                    <input type="text" id="tenant_phone_number" name="tenant[phone_number]" class="form-control" placeholder="Phone Number" value="" required>
                  </div>
    
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="addTenantBtn">Add</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Adjust Summary -->
    <div class="modal fade" id="modalAdjustSummary" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <form id="search-address-form" method="post" action="/property/ajust_summary/">
          <input type="hidden" name="_csrf" value="<%= token %>">
          <input type="hidden" name="property[id]" value="<%= property.id%>">
          <div class="modal-content bg-lighter">
            <div class="modal-header">
                <!-- Header -->
              <h3 class="modal-title">Adjust Summary</h3>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
    
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Current Valuation
                    </label>
                    <div class="input-group input-group-merge mb-3">
                      <input type="text" onkeypress="return isNumberKey(event)" name="property[current_value]" id="property_current_value" class="form-control form-control-prepended number" placeholder="" value="<%=property.current_value.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')%>" required>
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <span>£</span>
                        </div>
                      </div>
                    </div>
                  </div>
    
                </div>
                <div class="col-12 col-md-6 d-flex align-items-center">
                  <button type="button" class="btn btn-primary" id="estimatePropertyBtn" data-property="<%=JSON.stringify(property)%>">
                    <span class="spinner-grow spinner-grow-sm d-none" role="status" aria-hidden="true"></span> 
                    Use Avenue Estimate 
                  </button>
                </div>
              </div>
              <div class="row">
                <div class="col-12 col-md-6">
                  
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Annual Income
                    </label>
                    <div class="input-group input-group-merge mb-3">
                      <input type="text" name="property[rental_income]" class="form-control form-control-prepended" placeholder="<%= property.rental_income.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')%>" value="" required readonly>
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <span>£</span>
                        </div>
                      </div>
                    </div>
                  </div>
    
                </div>
               
              </div>
              <div class="row">
                <div class="col-12 col-md-6">
                  <!-- Start date -->
                  <div class="form-group">
                    <label>
                      Rental Yield % 
                    </label>
                    <input type="text" name="property[rental_yield]" class="form-control " placeholder="<%= property.rental_yield.toFixed(2)%>" value="" required readonly>
                 
                  </div>
    
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <% include ../partials/topnav %>
  
    <!-- MAIN CONTENT
    ================================================== -->
    <div class="main-content">

      <!-- HEADER -->
      <div class="header">
        <div class="container">
          
          <!-- Body -->
          <div class="header-body">
            <div class="row align-items-center">
              <div class="col-auto">

                <!-- Avatar -->
                <div class="avatar avatar-lg avatar-4by3">
                  <img src="/img/avatars/projects/project-1.jpg" alt="..." class="avatar-img rounded">
                </div>

              </div>
              <div class="col ml-n3 ml-md-n2">
                
                <!-- Pretitle -->
                <h6 class="header-pretitle">
                  Property
                </h6>

                <!-- Title -->
                <h1 class="header-title">
                  <%= property.address%>, <%= property.city%>
                </h1>

              </div>

            </div> <!-- / .row -->
            <div class="row align-items-center">
              <div class="col">
                
                <!-- Nav -->
                <ul class="nav nav-tabs nav-overflow header-tabs">
                  <li class="nav-item">
                    <a href="javascript:void(0)" data-href="#overview" class="nav-link overview-tab">
                      Overview
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="javascript:void(0)" data-href="#units" class="nav-link unit-tab"  <% if (total_units == 1) { %> data-unit="<%=property.tenancies[0].id%>" <% }%>>
                      <% if (total_units > 1) { %> Units <% }%> <% if (total_units == 1) { %> Tenancy <% }%> <% if (property.tenancies.length > 1) {%><span class="badge badge-pill badge-soft-secondary"><%=property.tenancies.length%></span><% }%>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="javascript:void(0)" data-href="#income_expenses" data-toggle="tab" role="tab" class="nav-link overview-tab">
                      Income & Expenses
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="javascript:void(0)" data-href="#documents" data-toggle="tab" role="tab" class="nav-link overview-tab">
                      Documents <span class="badge badge-pill badge-soft-secondary doc_cnt"><%=documents.length%></span>
                    </a>
                  </li>
                </ul>

              </div>
            </div>
			
          </div>

        </div>
      </div> <!-- / .header -->

      <!-- CONTENT -->
      <div class="container">
        <div class="tab-content">
          <div class="tab-pane fade" id="overview" role="tabpanel">
         <!-- Alert -->
           <!--  <div class="alert alert-warning" role="alert">
              This property profile is only <%=empty_cnt%>% complete. <a href="/property/detail/<%=property.id%>" class="alert-link">Add more details here</a>
            </div> -->
            
            <div class="row">
              <div class="col-12 col-xl-8">
              
                <!-- Card -->
                <div class="card">
  				  
                  <div class="card-header">
                    <div class="row align-items-center">
                      <div class="col">

                        <!-- Title -->
                        <h4 class="card-header-title">
                          Summary
                        </h4>

                      </div>
  					
                      <div class="col-auto">

                        <!-- Button -->
                        <button class="btn btn-sm btn-white" data-toggle="modal" data-target="#modalAdjustSummary">
                          Adjust
                        </button>
                    
                      </div>
                     
                    </div> <!-- / .row -->
                  </div>
  				
                  <div class="card-body">
                    <div class="row align-items-center no-gutters">
                      <div class="col-4 text-center border-right">
                        <!-- Title -->
                        <h6 class="card-title text-uppercase text-muted mb-2">
                          Est Market Value
                        </h6>
                
                        <!-- Heading -->
                        <span class="h2 mb-0">
                          £<%=property.current_value.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')%>
                        </span>
                      
                      </div>
                      <div class="col-4 text-center border-right">
                          <!-- Title -->
                        <h6 class="card-title text-uppercase text-muted mb-2">
                          Annual Income
                        </h6>
                
                        <!-- Heading -->
                        <span class="h2 mb-0">
                          £<%=property.rental_income.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')%>
                        </span>
                      
                      </div>

                      <div class="col-4 text-center">
                          <!-- Title -->
                        <h6 class="card-title text-uppercase text-muted mb-2">
                            Rental Yield
                        </h6>
                
                        <!-- Heading -->
                        <span class="h2 mb-0">
                          <%=property.rental_yield.toFixed(2).replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')%>%
                        </span>
                      
                      </div>

                    </div> <!-- / .row -->
                  
                    </div> 
      		      </div>
  			  
              <!-- Card -->
                <div class="card">
      		  
                  <div class="card-header">
                    <div class="row align-items-center">
                      <div class="col">

                        <!-- Title -->
                        <h4 class="card-header-title">
                          Occupancy
                        </h4>

                      </div>
      			
                      <div class="col-auto">

                        <!-- Button -->
                        <button class="btn btn-sm btn-white" data-toggle="modal" data-target="#modalAddNewUnit">
                          Manage
                        </button>
                    
                      </div>
                     
                    </div> <!-- / .row -->
                  </div>
      		
                  <div class="card-body">
                    <div class="row align-items-center justify-content-center">
                      <div class="col-4 text-center border-right">
                        <!-- Heading -->
                        <!-- <div class="chart chart-appended">
                          <canvas id="tenancyChart" class="chart-canvas" data-labels="<%=chart_labels%>" data-dataset="[<%=chart_data%>]"></canvas>
                        </div> -->
                        <div id="container" style="width:250px; height:200px;"></div>
                      </div>
                      <div class="col-4 text-center border-right">
                        <!-- Heading -->
                        <h6 class="card-title text-muted text-uppercase mt-2">
                          Units in total
                        </h6>
                        <span class="h2">
                          <%=total_units%>
                        </span>
                      </div>
                      <div class="col-4 text-center">
                        <!-- Heading -->
                        <h6 class="card-title text-uppercase text-muted mt-2">
                          Vacant
                        </h6>
                        <span class="h2">
                          <%=vacant_cnt%>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="card">
            
                  <div class="card-header">
                    <div class="row align-items-center">
                      <div class="col">

                        <!-- Title -->
                        <h4 class="card-header-title">
                          Income & Expenses
                        </h4>

                      </div>
            
                      <div class="col-auto">

                        <!-- Button -->
                        <button class="btn btn-sm btn-white" data-toggle="modal" data-target="#modalAddNewUnit">
                          Manage
                        </button>
                    
                      </div>
                     
                    </div> <!-- / .row -->
                  </div>
                  <div class="card-body">
                  </div>
                </div>
      			  
              </div>
    			
              <div class="col-12 col-xl-4">
              
                <!-- Card -->
                <div class="card">
                    <div class="card-header">
                      <div class="row align-items-center">
                        <div class="col">

                          <!-- Title -->
                          <h4 class="card-header-title">
                            Property Details
                          </h4>

                        </div>
                        <div class="col-auto">

                          <!-- Button -->
                          <a href="/property/detail/<%= property.id%>" class="btn btn-sm btn-white">
                            Edit
                          </a>
                      
                        </div>
                      </div> <!-- / .row -->
                    </div>
  				  
                  <div class="card-body">

                    <div class="row align-items-center">
                      <div class="col">
                      
                        <!-- Title -->
                        <h5 class="mb-0">
                          Property Type
                        </h5>

                      </div>
                      <div class="col-auto">
                      
                        <small class="small text-muted text-capitalize"> 
                          <%=property.type%>
                        </small>

                      </div>
                    </div> <!-- / .row -->
                     <!-- Divider -->
                     <hr>
                    <div class="row align-items-center">
                      <div class="col">
                      
                        <!-- Title -->
                        <h5 class="mb-0">
                          Ownership
                        </h5>

                      </div>
                      <div class="col-auto">
                      
                        <small class="small text-muted text-capitalize"> 
                          <%= property.ownership%>
                        </small>

                      </div>
                    </div> <!-- / .row -->
                     <!-- Divider -->
                     <hr>
                    <div class="row align-items-center">
                      <div class="col">
                      
                        <!-- Title -->
                        <h5 class="mb-0">
                          Date of acquisition
                        </h5>

                      </div>
                      <div class="col-auto">
                      
                        <time class="small text-muted" datetime="1988-24-10">
                          <%= property.purchase_date%>
                        </time>

                      </div>
                    </div> <!-- / .row -->

                    <!-- Divider -->
                    <hr>

                    <div class="row align-items-center">
                      <div class="col">
                      
                        <!-- Title -->
                        <h5 class="mb-0">
                          Acquired for
                        </h5>

                      </div>
                      <div class="col-auto">
                      
                        <small class="text-muted text-capitalize">
                          <%= property.purchase_price%>
                        </small>

                      </div>
                    </div> <!-- / .row -->

                    <!-- Divider -->
                    <hr>

                    <div class="row align-items-center">
                      <div class="col">
                      
                        <!-- Title -->
                        <h5 class="mb-0">
                          Property size
                        </h5>

                      </div>
                      <div class="col-auto">
                      
                        <small class="text-muted">
                            <%= property.square_feet.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,') + " sq ft"%>
                        </small>

                      </div>
                    </div> <!-- / .row -->
  				  
                  </div>
                </div>

                <!-- Weekly Hours -->
                <div class="card">
                  <div class="card-header">
                  
                    <!-- Title -->
                    <h4 class="card-header-title">
                      Location
                    </h4>

                  </div>
                  <div class="card-body">
                  
                  <div class="embed-responsive embed-responsive-21by9 rounded">
                    <div class="embed-responsive-item" id="map" data-toggle="cmap" data-option='{"center": [<%= property.lng%>, <%= property.lat%>], "zoom": 12, "markers": [{"lng":<%= property.lng%>, "lat":<%= property.lat%>}]}'></div>
                  </div>

                  </div>
                </div>
  			  
                <!-- Latest Files -->
                <div class="card">
                  <div class="card-header">
                    <div class="row align-items-center">
                      <div class="col">
                      
                        <!-- Title -->
                        <h4 class="card-header-title">
                          Latest Files
                        </h4>

                      </div>
                      <div class="col-auto">

                        <!-- Link -->
                        <a href="#!" class="small">View all</a>
                      
                      </div>
                    </div> <!-- / .row -->
                  </div>
                  <div class="card-body">
                    <% for (var i = 0; i < documents.length; i++) { %>
                      <% var date = new Date(documents[i].created_at); var uploaded_at = date.getDate() + '/' +  date.getMonth()+1 + '/' + date.getFullYear();%>
                      <div class="row align-items-center">
                        <div class="col-auto">
                        
                          <!-- Avatar -->
                          <a href="#!" class="avatar">
                            <div class="avatar-title rounded bg-white text-secondary">
                              <span class="fe fe-file"></span>
                            </div>
                          </a>

                        </div>
                        <div class="col ml-n2">

                          <!-- Title -->
                          <h4 class="card-title mb-1">
                            <a href="/<%=documents[i].path%>" target="_blank"><%=documents[i].filename %></a>
                          </h4>

                          <!-- Time -->
                          <p class="card-text small text-muted">
                            <%=documents[i].tag%> &bull; <%=uploaded_at %>
                          </p>
                        
                        </div>
                        
                      </div> <!-- / .row -->

                      <!-- Divider -->
                      <hr>
                    <% } %>
                  </div> <!-- / .card-body -->
                </div> <!-- / .card -->

              </div>
            
            </div> <!-- / .row -->
          </div>

          <div class="tab-pane fade" id="units" role="tabpanel">
            <div class="col-12">
              <button class="btn btn-primary lift mb-3 btn-add-unit" data-toggle="modal" data-target="#modalAddNewUnit">
                Add a unit
              </button>
              <div class="units-list">
                <% property.tenancies.forEach( function(unit){ %>
                  <% if (unit.rent_frequency == 'Vacant') {%>
                    <div class="card">
                      <div class="card-body">
                        <div class="row align-items-center unit-item">
                          <div class="col-auto">
                        
                            <!-- Avatar -->
                            <h1 class="mb-0 avatar avatar-md">
                              <img src="/img/icons/unit.png" class="avatar-img">
                            </h1>
        
                          </div>
                          <div class="col-4">
        
                            <!-- Title -->
                            <h4 class="card-title mb-1">
                              <a href="#" class="detail-unit" data-unit="<%=JSON.stringify(unit)%>"><%= unit.description%></a>
                            </h4>
        
                            <!-- Time -->
                            <p class="card-text small text-muted">
                              Vacant &nbsp;&nbsp;●&nbsp; &nbsp; <a href="#" class="edit-unit" data-unit="<%= JSON.stringify(unit)%>" >Add a tenancy</a>
                            </p>
                          </div>
                          <div class="col-4">
                            <!-- Title -->
                            <h4 class="card-title mb-1">
                              Not Collecting Rent
                            </h4>
                            
                          </div>
                          <div class="col-2">
                            <% if (unit.tenants.length == 0) { %>
                              No Tenants
                            <% } %>
                            <% if (unit.tenants.length == 1) { %> 
                              1 Tenant
                            <% } %>
                            <% if (unit.tenants.length > 1) { %> 
                              <%=unit.tenants%> Tenants
                            <% } %>
                        
                          </div>
                          <div class="col-auto ml-auto">
                            <div class="dropdown">
                              <a href="#" class="dropdown-ellipses dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              <i class="fe fe-more-vertical"></i>
                              </a>
                              <div class="dropdown-menu dropdown-menu-right">
                                <a href="#!" class="dropdown-item edit-unit" data-unit="<%=JSON.stringify(unit)%>">
                                  Edit
                                </a>
                                <a href="#!" class="dropdown-item delete-unit action-unit" data-block="units" data-unit="<%=unit.id%>">
                                  Remove
                                </a>
                              </div>
                          </div>
                          </div>
                        </div> <!-- / .row -->
                          <!-- Divider -->
                      </div>
                    </div>
                  <% } else {%>
                  <div class="card">
                    <div class="card-body">
                      <div class="row align-items-center unit-item">
                        <div class="col-auto">
                      
                          <!-- Avatar -->
                          <h1 class="mb-0 avatar avatar-md">
                            <img src="/img/icons/unit.png" class="avatar-img">
                          </h1>
      
                        </div>
                        <div class="col-4">
      
                          <!-- Title -->
                          <h4 class="card-title mb-1">
                            <a href="#" class="detail-unit" data-unit="<%=JSON.stringify(unit)%>"><%= unit.description%></a>
                          </h4>
      
                          <!-- Time -->
                          <p class="card-text small text-muted">
                            <span class="text-success mr-2">●</span> Active Tenancy
                          </p>
                        </div>
                        <div class="col-4">
                          <!-- Title -->
                          <h4 class="card-title mb-1">
                            <% if (parseInt(unit.rent_price) > 0) {%>£<%= unit.rent_price.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')%><%}%>
                            Per <%= unit.rent_frequency%>
                          </h4>
                          
                        </div>
                        <div class="col-2">
                          <% if (unit.tenants.length == 0) { %>
                            No Tenants
                          <% } %>
                          <% if (unit.tenants.length == 1) { %> 
                            1 Tenant
                          <% } %>
                          <% if (unit.tenants.length > 1) { %> 
                            <%=unit.tenants%> Tenants
                          <% } %>

                        </div>
                        <div class="col-auto ml-auto">
                          <div class="dropdown">
                            <a href="#" class="dropdown-ellipses dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fe fe-more-vertical"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                              <a href="#!" class="dropdown-item edit-unit" data-unit="<%=JSON.stringify(unit)%>">
                                Edit
                              </a>
                              <a href="#!" class="dropdown-item delete-unit action-unit"  data-block="units" data-unit="<%=unit.id%>">
                                Remove
                              </a>
                            </div>
                        </div>
                        </div>
                      </div> <!-- / .row -->
                        <!-- Divider -->
                    </div>
                  </div>
                  <% } %>
                <% })%>
              </div>
              <div class="unit-detail-section d-none">
                <% if (property.units.length > 1) { %>
                  <button class="btn btn-primary back-to-units-list lift mb-3">
                    Back to units
                  </button>
                <% } %>

                <div class="card">
                  <div class="card-header">
                    <div class="row align-items-center">
                      <div class="col">

                        <!-- Title -->
                        <h4 class="card-header-title unit-name">
                          Single Unit
                        </h4>

                      </div>
          
                      <div class="col-auto">

                        <!-- Button -->
                        <a href="#!" class="btn btn-sm btn-white edit-unit update-detail" data-unit="">
                          Update details
                        </a>
                  
                      </div>
                   
                    </div> <!-- / .row -->
                  </div>
                  <div class="card-body row">
                    <div class="col-12 col-md-6">
                      <ul class="row">
                        <li class="col-6 unit-rent-section"></li>
                        <li class="col-6 unit-deposit-section"></li>
                      </ul>
                      <ul class="row">
                        <li class="col-6"><span class="unit-tenants"></span></li>
                        <li class="col-6"><span class="unit-start_date"></span> <i style="font-weight: bold;">~</i> <span class="unit-end_date"></span></li>
                      </ul>
                    </div>
                  </div> 
                </div>

                <div class="card">
                  <div class="card-header">
                    <div class="row align-items-center">
                      <div class="col">
                        <!-- Title -->
                        <h4 class="card-header-title">
                          Tenants
                        </h4>
                      </div>
                      <div class="col-auto">
                        <!-- Button -->
                        <a href="#!" class="btn btn-sm btn-white add-tenant">
                          Add
                        </a>
                      </div>
                    </div> <!-- / .row -->
                  </div>
                  <div class="card-body row tenant-list">
                   
                  </div> 
                </div>

                <div class="card">
                  <div class="card-header">
                    <div class="row align-items-center">
                      <div class="col">

                        <!-- Title -->
                        <h4 class="card-header-title">
                          Documents
                        </h4>

                      </div>
          
                      <div class="col-auto">

                        <!-- Button -->
                        <a href="#!" class="btn btn-sm btn-white modal-upload modal-unit" data-unit="" data-property="<%=JSON.stringify(property)%>">
                          Upload
                        </a>
                  
                      </div>
                   
                    </div> <!-- / .row -->
                  </div>
                  <div class="card-body">
                    <ul class="list-group list-group-lg list-group-flush list my-n4 unit-document-list">
                      
                    </ul>
                  </div> 
                </div>

                <div class="card">
                  <div class="card-body">
                    <a href="#" class="btn btn-danger lift action-unit btn-unit-delete" data-block="units">
                      Delete Unit
                    </a>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="income_expenses" role="tabpanel">
            <div class="row">
              <div class="col-12 col-xl-8">
              </div>
            </div>
          </div>

          <div class="tab-pane fade" id="documents" role="tabpanel">
            <% include ./_documents %>
          </div>
		    </div>
      </div>
      
    </div> <!-- / .main-content -->

    <input type="hidden" name="documents" id="hidden_documents" value="<%=JSON.stringify(documents)%>">
    <input type="hidden" name="units" id="hidden_units" value="<%=JSON.stringify(property.tenancies)%>">
    <input type="hidden" id="hidden_property" value="<%=JSON.stringify(property)%>">
    <% include ../partials/modals %>
    <!-- JAVASCRIPT
    ================================================== -->
    <% include ../partials/scripts %>

    <script type="text/javascript">
      const _unit_id = '<%=unit_id%>';
      let _tabs = '<%=tabs%>';
      const _property_id = '<%=property_id%>';
      
      let documents = [];
      let units = [];
      try {
        documents = JSON.parse($('#hidden_documents').val());
        units = JSON.parse($('#hidden_units').val());
        items = documents;
      } catch(e){}

      const gotoTab = (tabs) => {
        $('.tab-pane').removeClass('active show');
        $('.overview-tab').removeClass('active');
        $('#'+tabs).addClass('active show');
        $(`a[data-href="#${tabs}"]`).addClass('active');
      }

      $(function() {
        // Create the chart
        var colors = Highcharts.getOptions().colors;
        Highcharts.chart('container', {
            chart: {
                type: 'pie'
            },
            title: {
                text: ''
            },
            plotOptions: {
              series: {
                  dataLabels: {
                      enabled: false,
                      format: '{point.name}: {point.y:.1f}%'
                  }
              }
            },
            tooltip: {
                headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b> of total<br/>'
            },
            series: [{
              name: "Occupied",
              size: '100%',
              innerSize: '60%',
              colorByPoint: true,
              data: [
                  {
                      name: "Vacant",
                      color: colors[1],
                      y: <%=vacant_value%>,
                      drilldown: "Vacant"
                  },
                  {
                      name: "Tenancy",
                      color: colors[4],
                      y: <%=tenancy_value%>,
                      drilldown: "Tenancy"
              }]
            }]
        });

        $('.overview-tab').click(function(e){
          e.preventDefault();
          const new_tabs =  $(this).attr('data-href').replace('#', '');
          if (!_tabs || _tabs != new_tabs) {
            location.href = '/property/overview/' + _property_id  + '/' + new_tabs;
          }
        });

        $('.unit-tab').click(function(e){
          e.preventDefault();
          if (units.length == 1) {
            location.href = '/property/overview/' + _property_id  + '/units/' + $(this).data('unit');
          } else {
            location.href = '/property/overview/' + _property_id  + '/units';
          }
        });

        
        $('.detail-unit').click(function(e) {
          e.preventDefault();
          const unit = $(this).data('unit');
          $('.unit-detail-section').removeClass('d-none');
          $('.units-list').addClass('d-none');
          $('.btn-add-unit').addClass('d-none');

          $('.update-detail').attr('data-unit', JSON.stringify(unit));
          $('.modal-unit').attr('data-unit', JSON.stringify(unit));
          const unit_documents = documents.filter(document => document.unit_id == unit.id);
          unit.tenants = unit.tenants ? unit.tenants : [];
          let tenants_cnt = unit.tenants.length;
          tenants_cnt = tenants_cnt == 1 ?  tenants_cnt + ' Tenant' : tenants_cnt + ' Tenants';

          if (units.length > 1) {
            $('.unit-name').text(unit.description);
          }
          if (unit.deposit) {
            $('.unit-deposit-section').html(`£<span class="unit-deposit">${toComma(unit.deposit)}</span> Deposit`);
          } else {
            $('.unit-deposit-section').text('No deposit')
          }
          if (unit.rent_price) {
            $('.unit-rent-section').html(`£<span class="unit-rent">${toComma(unit.rent_price)}</span> <span class="unit-frequency">${unit.rent_frequency}</span> Rent`);
          } else {
            $('.unit-rent-section').text('No rent price ');
          }

          if (unit.tenants.length) {
            $('.unit-tenants').text(tenants_cnt);
          } else {
            $('.unit-tenants').text('No Tenant');
          }
          $('.unit-start_date').text(unit.start_date);
          $('.unit-end_date').text(unit.end_date);
          $('input[name="unit[id]"]').val(unit.id);

          // display tenants section
          $('.tenant-list').empty();
          unit.tenants.map(tenant => {
            addTenant(tenant, unit);
          });

          $(document).on('click', '.delete-tenant', function() {
            confirmDialog("Are you sure?", (ans) => {
              if (ans) {
                const _csrf = $('input[name="_csrf"]').val();
                const property_id = $('input[name="property[id]"]').val();
                const unit_id = $('input[name="unit[id]"]').val();
                const tenant_id = $(this).data('id');
                var parent = $(this).parents('.tenant-item');
                fetch(new Request('/property/unit/tenant/delete', {method: 'POST', headers:{'Content-Type': 'application/json'}, body: JSON.stringify({unit_id, property_id, tenant_id, _csrf})}))
                .then(response => response.json())
                .then(function(res) {
                  parent.remove();
                  if (res.cnt == 0) {
                    $('.tenant-list').append(`<div class="col-auto no-tenants"><p>There is no tenants yet</p></div>`);
                  }
                  let tenants_cnt = res.cnt == 1 ?  res.cnt + ' Tenant' : res.cnt + ' Tenants';
                  if (res.cnt) {
                    $('.no-tenants').remove();
                    $('.unit-tenants').text(tenants_cnt);
                  } else {
                    $('.unit-tenants').text('No Tenant');
                  }
                }).catch(function(text) {
                    console.log(text);
                });
              }
            });
          });

          $('.add-tenant').click(function() {
            $('#modalAddNewTenant').modal()
              .on('shown.bs.modal', function () {
                $('#tenant-modal-title').html('Add a New Tenant');
                $('#addTenantBtn').html('Add');
              });
          })

          $(document).on('click', '.edit-tenant', function() {
            const tenant_id = $(this).data('id');
            $('input[name="unit[id]"]').val($(this).data('unit'));
            $('input[name="tenant[id]"]').val(tenant_id);
            const tenant = $(this).data('tenant');
            $('#tenant_first_name').val(tenant.first_name);
            $('#tenant_last_name').val(tenant.last_name);
            $('#tenant_email').val(tenant.email);
            $('#tenant_phone_number').val(tenant.phone_number);
            $('#modalAddNewTenant').modal()
              .on('shown.bs.modal', function () {
                $('#tenant-modal-title').html('Edit a Tenant');
                $('#addTenantBtn').html('Update');
                $('#tenant_id').val(tenant_id);
              })
              .on('hidden.bs.modal', function () {
                $('#tenant-modal-title').html('Add a New Tenant');
                $('#addTenantBtn').html('Add');
                $('#tenant_first_name').val('');
                $('#tenant_last_name').val('');
                $('#tenant_email').val('');
                $('#tenant_phone_number').val('');
                $('#tenant_id').val();
              });
          });

          if (unit.tenants.length == 0) {
            $('.tenant-list').append(`<div class="col-auto no-tenants"><p>There is no tenants yet</p></div>`);
          }

          // display documents section
          $('.unit-document-list').empty();
          unit_documents.forEach(doc => {
            const property = JSON.parse($('#hidden_property').val());
            const date = new Date(doc.created_at);
            const uploaded_at = date.getDate() + '/' +  date.getMonth()+1 + '/' + date.getFullYear();
            $('.unit-document-list').append(`<li class="list-group-item px-0">
              <div class="row align-items-center">
                <div class="col-auto">
                  
                  <!-- Avatar -->
                  <h1 class="mb-0 avatar avatar-md">
                    <img src="/img/icons/unit.png" class="avatar-img">
                  </h1>

                </div>
                <div class="col ml-n2">

                  <!-- Title -->
                  <h4 class="card-title mb-1 name">
                    <a target="_blank" href="/${doc.path}">${doc.filename}</a>
                  </h4>

                  <!-- Time -->
                  <p class="card-text small text-muted">
                    Uploaded on <time datetime="${uploaded_at}">${uploaded_at}</time>
                  </p>
                  
                </div>
                <div class="col-auto">
                  
                  <!-- Button -->
                  <a href="/${doc.path}" target="_blank" class="btn btn-sm btn-white d-none d-md-inline-block">
                    View
                  </a>

                </div>
                <div class="col-auto">
                  
                  <!-- Dropdown -->
                  <div class="dropdown">
                    <a href="#" class="dropdown-ellipses dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                      <i class="fe fe-more-vertical"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right">
                      <button class="dropdown-item edit-document modal-upload modal-unit" data-property="" data-unit="" data-id="${doc.id}" data-property_id="${doc.property_id}" data-property_name="${doc.property_name}" data-unit_id="${doc.unit_id}" data-unit_name="${doc.unit_name}" data-tag="${doc.tag}" data-path="${doc.path}" data-size="${doc.size}" data-filename="${doc.filename}" data-mimetype="${doc.mimetype}">
                        Edit
                      </button>
                      <a class="dropdown-item delete-document" data-id="${doc.id}">
                        Delete
                      </a>
                    </div>
                  </div>
                </div>
              </div> 
              </li>`)
          });

          if (unit_documents.length == 0) {
            $('.unit-document-list').append(`<div class="col-auto no-documents"><p>There is no documents yet</p></div>`)
          }

          $('.modal-upload').attr('data-property', $('#hidden_property').val());
        });

        // if this page is called from tenancies, then go to unit detail
        if (_unit_id) {
          $('a[href="#units"]').click();
          var target;
          $('.detail-unit').map( (i, e) => {
            if (JSON.stringify($(e).data('unit')).includes(_unit_id)) {
              target = $(e);
            }
          })
          if (target) {
            target.click();
          }
        }

        if (_tabs) {
          gotoTab(_tabs);
        }

        if (!_tabs) {
          gotoTab('overview');
        }

        // Overview
        $('.back-to-units-list').click(function(e) {
          e.preventDefault();
          location.href = '/property/overview/' + _property_id  + '/units';
        });

        // Display documents section
        $('.btn-primary.modal-upload').addClass('modal-property');
        doPopulate();
        doPaginate();
        $('.modal-upload').attr('data-property', $('#hidden_property').val());
        $('.edit-document').addClass('modal-property').attr('data-property', $('#hidden_property').val());
        if (document.querySelector('.dropzone')) {
          Dropzone_init( document.querySelector('.dropzone'));
        }
      });
    </script>
  </body>
</html>